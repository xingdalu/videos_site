name: Release

on:
  push:
    tags:
    - '*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
        
      - id: files
        uses: jitterbit/get-changed-files@v1
        with:
          format: 'json'
          token: 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
      - run: |
          for changed_file in ${{ steps.files.outputs.all }}; do
            echo "Do something with this ${changed_file}."
          done
        
      - name: Generate Second Release
        run: echo RELEASE_VERSION=`git describe --abbrev=0 --tags $(git rev-list --tags --skip=1  --max-count=1)` >> $GITHUB_ENV
        
      - run: echo ${{ env.RELEASE_VERSION }}

      - name: Generate changelog
        id: changelog
        uses: metcalfc/changelog-generator@v1.0.0
        with:
          myToken: ${{ secrets.XINGDALU_PERSONAL_TOKEN }}
          base-ref: ${{ env.RELEASE_VERSION }}


#       - name: Create Release
#         id: create_release
#         uses: actions/create-release@latest
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         with:
#           tag_name: ${{ github.ref }}
#           release_name: Release ${{ github.ref }}
#           body: ${{ steps.changelog.outputs.changelog }}
#           draft: false
#           prerelease: false
          
#       - name: Generate changelog
#         id: changelog
#         uses: xingdalu/changelog-generator@v1.0.2
#         with:
#           myToken: ${{ secrets.XINGDALU_PERSONAL_TOKEN }}
#           base-ref: ${{ env.RELEASE_VERSION }}
      - name: wechat-work robot
        uses: fifsky/wechat-work-action@master
        with:
          url: ${{ secrets.WECHAT_WORK_BOT_WEBHOOK }}
          type: markdown
          content: |
            **更新摘要**:
            ${{ steps.changelog.outputs.changelog }}
            ${{ steps.cdc.outputs.commit-difference-count }}
 
